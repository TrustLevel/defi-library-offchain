# Defi Library Offchain Components

Contains logic and demonstration for the follwoing smart contracts:

    1. Collateral Management Logic
    2. Lending Pool (Issuance & Redemption logic)

**NOTE**: Details on the onchain components design can be found [here](https://lending-aiken-docs.staking.rocks).

## Prerequisites

- [Deno](https://docs.deno.com/runtime/getting_started/installation/) must already be installed on the machine to run the
  scripts in this package. Deno `v2.2.6` was used during development.
- Compiled Plutus scripts in a [_blueprint_ file](./onchain/plutus.json) generated by `Aiken` (`plutus.json`) must be present in
  subdirectory `./onchain` before running any script in this package that interacts with onchain components.

## Installing

```
git clone https://github.com/dominiktilman/defi-library-offchain.git defi-library-offchain && \
cd defi-library-offchain && \
deno install --allow-scripts=npm:cbor-extract
```

### Prep env vars

Copy the file `./.env_sample` into `./.env` and fill in required variables. [Kupo](https://cardanosolutions.github.io/kupo/) and
[Ogmios](https://ogmios.dev/) endpoints can be conveniently taken from [Demeter.run](https://demeter.run/) services.

For the seed phrases, it can be from any Cardano wallet app.

## Running

Be sure to have some `tADA` in the admin and user accounts before proceeding. For convenience, testnet faucet can be found
[here](https://docs.cardano.org/cardano-testnets/tools/faucet).

Following commands should be run from the project root directory:

#### Initialization

1. Mint the beacon tokens that will mark the utxos containing the protocol's validator scripts as _reference scripts_.
   ```shell
   deno task mint-beacon-tokens
   ```

1. When the beacon tokens are ready, deploy the validator scripts as _reference scripts_. This will store the compiled
   validators into separate utxos, identified by the corresponding beacon token they each contain.

   These utxos will go to the `refscripts` validator address, a separate contract made for holding these reference utxos.

   ```
   deno task deploy-refscripts
   ```

1. Mint the _test_ loanable tokens (tUSDM). The CIP68 reference token will likewise go to the `refscripts` address. And most of
   the CIP68 user token will go to the admin address. Some user token will also be sent to the "user1" address. This will be
   required later when testing a tx to repay their loan + interest.
   ```
   deno task mint-loanable-tokens
   ```

1. When the _test_ loanable tokens arrive at the admin account, it can then be deposited into the `lending_pool` contract. The
   utxo on the `lending_pool` created by this tx contains the protocol's initial settings.
   ```
   deno task deposit-loanable-asset
   ```

   Lending pool's initial settings:
   ```
   // typescript
   {
      collateral_contract: ScriptHash;
      loanable_asset: {
         policy_id: string;
         asset_name: string;
      };
      collateral_asset: {
         policy_id: string;
         asset_name: string;
      };
      collateral_price: [bigint, bigint]; // [price, decimal digits]
      collateral_ratio: bigint;
      interest_rates: [bigint, bigint][]; // [term (in milliseconds), rate][]
   }
   ```

#### User Interaction

1. Deposit collateral asset (currently set to ADA):
   ```
   deno task deposit-collateral-asset
   ```

   This creates a collateral utxo for the user, at the `collateral` contract address. The utxo will have the following datum:

   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      used_in: None,
   }
   ```

1. Borrow against collateral (this locks the collateral):
   ```
   deno task borrow
   ```

   This script creates 2 txs - the 1st one simulating the user's request to take a loan, and the 2nd one chained to the 1st is
   simulating the admin/backend's loan request fulfillment action.

   The first tx (user's action) updates the collateral utxo datum to the following:
   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      used_in: Some(LoanDatum {
         status: LoanRequested,
         borrowed_asset: AssetClass,
         borrowed_amt: Int,
         interest_amt: Int,   // set to 0 only for now
         loan_term: Int,
         maturity: PosixTime, // set to 0 only for now
      }),
   }
   ```

   The second tx (admin's action) spends from the `lending_pool` contract and sends the borrowed asset to the user's address and
   updates the collateral utxo datum to the following:
   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      used_in: Some(LoanDatum {
         status: LoanProcessed,    // this changed
         borrowed_asset: AssetClass,
         borrowed_amt: Int,
         interest_amt: Int,   // interest amt is calculated and updated here
         loan_term: Int,
         maturity: PosixTime, // maturity date is also calculated and updated here
      }),
   }
   ```

   This locks the collateral utxo and it cannot be withdrawn by its owner.

1. Repay borrowed asset (this unlocks collateral):
   ```
   deno task repay
   ```
   This script creates 2 txs - the 1st one simulating the user's request to repay their loan, and the 2nd one chained to the 1st
   is simulating the admin/backend's repayment request fulfillment action.

   The first tx (user's action) updates the collateral utxo to now also contain the repayment asset, and its datum is changed to
   the following:
   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      used_in: Some(LoanDatum {
         status: RepayRequested,  // this changed
         borrowed_asset: AssetClass,
         borrowed_amt: Int,
         interest_amt: Int,   
         loan_term: Int,
         maturity: PosixTime, 
      }),
   }
   ```

   The second tx (admin's action) sends the repayment asset (principal + interest) back to the `lending_pool` contract and
   updates the collateral utxo datum back to the following (unlocked state):

   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      used_in: None
   }
   ```

1. Withdraw unlocked collateral:
   ```
   deno task withdraw-collateral
   ```

#### Maintenance/Admin Interactions

These scripts have been prepared for convenience in testing.

1. Withdraw loanable assets from the `lending_pool` contract:
   ```
   deno task withdraw-loanable-asset
   ```

1. Reset collateral status (for when a loan request was created by user - locking their collateral - but the chained tx to fulfill that loan request failed):
   ```
   deno task reset-collateral
   ```
   This returns the user's collateral back to the `collateral` contract and gives it 'unlocked' status, allowing the user to withdraw it or use it for another loan request.

1. Burn the minted test loanable assets:
   ```
   deno task burn-loanable-tokens
   ```

1. Undeploy refscripts:
   ```
   deno task undeploy-refscripts
   ```
   This spends the utxo's in the `refscripts` contract and returns the beacon tokens to the admin address without reference
   scripts in the output.
